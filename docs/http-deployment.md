# HTTP Transport & Cloud Deployment

The server supports two transport modes that are selected automatically at startup.

| Mode | When | Use case |
|------|------|----------|
| **STDIO** | `PORT` env var is **not** set | Local dev, Claude Desktop, npx |
| **HTTP (Streamable)** | `PORT` env var is set | Render, Railway, Fly.io, any cloud |

## HTTP Endpoints

| Path | Method(s) | Purpose |
|------|-----------|---------|
| `/mcp` | `POST`, `GET`, `DELETE` | MCP protocol (Streamable HTTP transport) |
| `/health` | `GET` | Health check — returns `{"status":"ok"}` |

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `PORT` | Yes (cloud) | Port to listen on — set automatically by most platforms |
| `FLUENTCRM_API_URL` | Yes* | Default FluentCRM REST API base URL |
| `FLUENTCRM_API_USERNAME` | Yes* | Default WordPress username |
| `FLUENTCRM_API_PASSWORD` | Yes* | WordPress Application Password |
| `MCP_AUTH_TOKEN` | Recommended | Bearer token required on every request to `/mcp` |
| `MCP_LANG` | No | Tool description language (`en` default, `pl` available) |

*Required only when not supplying per-connection headers (see Multi-site below).

## Deploy to Render

### Option A — render.yaml (recommended)

The repo ships a `render.yaml`. Connect your GitHub repo to Render and it will auto-configure the service.

1. Go to [render.com](https://render.com) → **New** → **Web Service**
2. Connect the `blocklienterprise/fluentcrm-mcp-server` repo
3. Render detects `render.yaml` and pre-fills all settings
4. Set the secret env vars in the dashboard (marked `sync: false` in `render.yaml`):
   - `FLUENTCRM_API_URL`
   - `FLUENTCRM_API_USERNAME`
   - `FLUENTCRM_API_PASSWORD`
5. `MCP_AUTH_TOKEN` is auto-generated by Render — copy it from the dashboard after first deploy

### Option B — manual

| Setting | Value |
|---------|-------|
| Runtime | Node |
| Build command | `npm install && npm run build` |
| Start command | `node dist/fluentcrm-mcp-server.js` |
| Health check path | `/health` |

## Authentication

When `MCP_AUTH_TOKEN` is set every request to `/mcp` must include:

```
Authorization: Bearer <MCP_AUTH_TOKEN>
```

If the token is missing or wrong the server returns `401 Unauthorized`.

> **Without `MCP_AUTH_TOKEN` the endpoint is open to anyone with the URL.**  
> Always set it on public deployments.

## Multi-Site Support

A single deployed instance can serve multiple WordPress sites. Each MCP client connection supplies its own FluentCRM credentials via request headers. The server creates an isolated session per connection.

### Per-connection headers

| Header | Fallback |
|--------|----------|
| `X-FluentCRM-Url` | `FLUENTCRM_API_URL` env var |
| `X-FluentCRM-Username` | `FLUENTCRM_API_USERNAME` env var |
| `X-FluentCRM-Password` | `FLUENTCRM_API_PASSWORD` env var |

If headers are absent the server falls back to the env vars, so single-site deployments need no changes.

### MCP Client Config (VS Code / Claude)

```json
{
  "mcpServers": {
    "my-site": {
      "type": "http",
      "url": "https://fluentcrm-mcp-server.onrender.com/mcp",
      "headers": {
        "Authorization": "Bearer <MCP_AUTH_TOKEN>",
        "X-FluentCRM-Url": "https://mysite.com/wp-json/fluent-crm/v2",
        "X-FluentCRM-Username": "mcp-user",
        "X-FluentCRM-Password": "xxxx xxxx xxxx xxxx xxxx xxxx"
      }
    },
    "client-site": {
      "type": "http",
      "url": "https://fluentcrm-mcp-server.onrender.com/mcp",
      "headers": {
        "Authorization": "Bearer <MCP_AUTH_TOKEN>",
        "X-FluentCRM-Url": "https://clientsite.com/wp-json/fluent-crm/v2",
        "X-FluentCRM-Username": "mcp-user",
        "X-FluentCRM-Password": "yyyy yyyy yyyy yyyy yyyy yyyy"
      }
    }
  }
}
```

The name (`"my-site"`, `"client-site"`) is just a label — use anything unique.

## Deploy to Other Platforms

Any platform that sets `PORT` and supports Node.js will work without code changes.

### Railway

```bash
railway up
```

Set env vars in the Railway dashboard. `PORT` is injected automatically.

### Fly.io

```bash
fly launch
fly secrets set MCP_AUTH_TOKEN=... FLUENTCRM_API_URL=... \
  FLUENTCRM_API_USERNAME=... FLUENTCRM_API_PASSWORD=...
fly deploy
```

### Docker

```dockerfile
FROM node:22-alpine
WORKDIR /app
COPY . .
RUN npm install && npm run build
CMD ["node", "dist/fluentcrm-mcp-server.js"]
```

```bash
docker run -p 3000:3000 \
  -e PORT=3000 \
  -e MCP_AUTH_TOKEN=secret \
  -e FLUENTCRM_API_URL=https://mysite.com/wp-json/fluent-crm/v2 \
  -e FLUENTCRM_API_USERNAME=user \
  -e FLUENTCRM_API_PASSWORD=pass \
  fluentcrm-mcp-server
```

## Local HTTP Mode (testing)

```bash
PORT=3000 MCP_AUTH_TOKEN=test123 node dist/fluentcrm-mcp-server.js
```

Health check:
```bash
curl http://localhost:3000/health
# {"status":"ok","server":"fluentcrm-mcp"}
```
